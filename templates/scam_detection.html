{% extends "base.html" %}

{% block title %}Scam Detection - SafeGuard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary me-3">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <div>
                        <h2 class="mb-1">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            Scam Detection
                        </h2>
                        <p class="text-muted mb-0">Analyze content to identify potential scams and fraudulent activities</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="fas fa-search me-2"></i>Content Analysis
                </h5>
                
                <form id="scamForm">
                    <div class="mb-4">
                        <label for="content" class="form-label">Enter content to analyze:</label>
                        <textarea class="form-control" id="content" name="content" rows="8" 
                                placeholder="Paste email content, message, or website text here..."></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-shield-alt me-2"></i>Analyze for Scams
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearForm()">
                            <i class="fas fa-eraser me-2"></i>Clear
                        </button>
                    </div>
                </form>

                <div id="loadingSpinner" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Analyzing...</span>
                    </div>
                    <p class="mt-2 text-muted">Analyzing content...</p>
                </div>

                <div id="results" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Analysis Results
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="resultContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-lightbulb text-warning me-2"></i>Detection Tips
                </h6>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        Look for urgent language
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        Check for spelling errors
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        Verify sender identity
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        Be wary of money requests
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('scamForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const content = document.getElementById('content').value.trim();
    if (!content) {
        alert('Please enter content to analyze');
        return;
    }
    
    // Show loading spinner
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('results').style.display = 'none';
    
    try {
        const response = await fetch('/analyze-scam', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content: content })
        });
        
        const data = await response.json();
        
        // Hide loading spinner
        document.getElementById('loadingSpinner').style.display = 'none';
        
        // Show results
        displayResults(data);
        
    } catch (error) {
        document.getElementById('loadingSpinner').style.display = 'none';
        alert('Error analyzing content. Please try again.');
        console.error('Error:', error);
    }
});

function displayResults(data) {
    const resultDiv = document.getElementById('resultContent');
    const riskLevel = data.is_scam ? data.risk_level || 'HIGH RISK' : 'LOW RISK';
    const riskClass = data.is_scam ? 'danger' : 'success';
    const riskIcon = data.is_scam ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle';
    
    let keywordsHtml = '';
    if (data.detected_keywords && data.detected_keywords.length > 0) {
        keywordsHtml = `
            <div class="mt-3">
                <h6>Detected Risk Keywords:</h6>
                <div>
                    ${data.detected_keywords.map(keyword => 
                        `<span class="badge bg-warning text-dark me-1">${keyword}</span>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    
    let factorsHtml = '';
    if (data.risk_factors && data.risk_factors.length > 0) {
        factorsHtml = `
            <div class="mt-3">
                <h6>Risk Factors Detected:</h6>
                <ul class="list-unstyled">
                    ${data.risk_factors.map(factor => 
                        `<li><i class="fas fa-exclamation-circle text-warning me-2"></i>${factor}</li>`
                    ).join('')}
                </ul>
            </div>
        `;
    }
    
    let recommendationsHtml = '';
    if (data.recommendations && data.recommendations.length > 0) {
        recommendationsHtml = `
            <div class="mt-4">
                <h6>Recommendations:</h6>
                <ul class="list-unstyled">
                    ${data.recommendations.map(rec => 
                        `<li class="mb-1">${rec}</li>`
                    ).join('')}
                </ul>
            </div>
        `;
    } else {
        // Fallback recommendations
        recommendationsHtml = `
            <div class="mt-4">
                <h6>Recommendations:</h6>
                <ul class="list-unstyled">
                    ${data.is_scam ? `
                        <li><i class="fas fa-times text-danger me-2"></i>Do not respond to this content</li>
                        <li><i class="fas fa-times text-danger me-2"></i>Do not click any links</li>
                        <li><i class="fas fa-times text-danger me-2"></i>Report as spam/scam</li>
                    ` : `
                        <li><i class="fas fa-check text-success me-2"></i>Content appears safe</li>
                        <li><i class="fas fa-check text-success me-2"></i>Still verify sender if unknown</li>
                    `}
                </ul>
            </div>
        `;
    }
    
    resultDiv.innerHTML = `
        <div class="alert alert-${riskClass} d-flex align-items-center">
            <i class="${riskIcon} me-2"></i>
            <div>
                <strong>${riskLevel}</strong> - ${data.message}
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Risk Score:</label>
                    <div class="progress">
                        <div class="progress-bar bg-${riskClass}" role="progressbar" 
                             style="width: ${data.scam_score}%" 
                             aria-valuenow="${data.scam_score}" aria-valuemin="0" aria-valuemax="100">
                            ${data.scam_score}%
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        ${keywordsHtml}
        ${factorsHtml}
        ${recommendationsHtml}
    `;
    
    document.getElementById('results').style.display = 'block';
}

function clearForm() {
    document.getElementById('content').value = '';
    document.getElementById('results').style.display = 'none';
}
</script>
{% endblock %}